# 广告系统核心概念：排序层 (Ranking Layer)

排序层是广告系统流程中**最核心、最智能的大脑**。如果说“召回层”是“复赛”，选出了几百个不错的候选广告，那么“排序层”就是“专家面试”。它负责对这几百个候选广告进行一次**极其深入、全面、精细化的评估和打分**，然后按照分数从高到低排出一个最终的座次，这个座次基本上就决定了用户最终看到的广告顺序。

## 1. 排序层的核心目标：精准预测

排序层的唯一目标就是**精准预测**。它要对每一个“用户-广告-环境”的组合，回答一个核心问题：

> “在当前这个时间、这个地点，把这个广告展示给这个用户，他有多大的可能会点击？(pCTR) 他点击后，又有多大的可能会转化？(pCVR)”

*   **pCTR (predicted Click-Through Rate):** 预估点击率。
*   **pCVR (predicted Conversion Rate):** 预估转化率。

这个预测出来的分数，是后续所有商业决策的基石。

---

## 2. 排序层的工作流三部曲

整个排序工作可以分为三个步骤：**特征 -> 模型 -> 分数**。

### A. 燃料：特征工程 (Feature Engineering)

模型是发动机，而特征就是燃料。排序模型需要“吃”进去海量的特征，才能做出准确的判断。这些特征主要分为四大类：

1.  **用户特征 (User Features):** 关于“人”的一切。
    *   **静态画像：** 年龄、性别、城市、长期兴趣标签等。
    *   **动态行为：** 最近7天点击/购买过的商品类目、搜索过的关键词、用户活跃度等。

2.  **广告特征 (Ad/Item Features):** 关于“广告”的一切。
    *   **基础属性：** 广告的行业、品类、素材类型（图片/视频）、广告主等。
    *   **历史表现：** 该广告上线以来的平均点击率、转化率等“历史成绩”。
    *   **内容信息：** 广告标题、文案的语义，图片/视频的内容和风格。

3.  **上下文特征 (Context Features):** 关于“环境”的一切。
    *   **时间、设备、网络、地理位置、用户正在浏览的页面**等。

4.  **交叉特征 (Cross Features):** **最关键的特征**，体现模型智能。
    *   它代表特征之间的“化学反应”。例如，“用户性别：女” 与 “广告品类：口红” 这两个特征交叉，就是一个非常强的信号。
    *   现代深度学习模型最擅长的就是自动发现这些人类难以穷举的、极其复杂的交叉特征。

### B. 引擎：排序模型 (Ranking Model)

海量的特征被喂给一个复杂的机器学习模型进行计算。其技术也经历了数代演进：

1.  **早期 (LR):** 逻辑回归模型，简单快速，但依赖大量人工特征工程。
2.  **中期 (GBDT+LR / FFM):** 使用树模型等进行自动特征组合，提升了效率和效果。
3.  **现代 (Deep Learning):** 这是当前所有大厂的标配。最经典的结构是 **Wide & Deep** 模型：
    *   **Wide 部分 (记忆能力):** 负责“记住”那些简单、直接、有效的历史规律。例如，“女性用户就是容易点美妆广告”。
    *   **Deep 部分 (泛化能力):** 通过多层神经网络，去探索和学习那些隐藏在数据背后的、抽象的、从未出现过的交叉关系，赋予模型强大的泛化和探索能力。

### C. 产出：预估分数 (Predicted Score)

模型经过计算后，会为每一个候选广告都输出一个精确的浮点数，例如 `pCTR = 0.05` (5%)，`pCVR = 0.10` (10%)。这个分数就是排序的直接依据。

---

## 3. 最终排序：eCPM 决胜

最后，系统会用模型预测出的分数，结合广告主的出价，计算出每个广告的 **eCPM (有效千次展示收入)**。

`eCPM = pCTR × pCVR × CPA出价 × 1000` (以oCPC为例)

系统按照 eCPM 从高到低进行排序，排名第一的广告赢得展示机会（此过程也可能受到“重排层”的微调）。

---

## 4. 对广告投手的意义

*   **素材和定向决定 pCTR 上限：** 你的广告素材是否吸引人，定向是否精准，直接决定了模型能为你的广告预测出多高的点击率。
*   **落地页和转化路径决定 pCVR 上限：** 你的落地页加载速度、用户体验、转化流程是否顺畅，直接影响了模型的转化率预测。
*   **出价是与系统沟通的工具：** 你的出价是在告诉系统：“我的用户转化一次，就值这么多钱”。系统会用你的出价乘以它预测出的概率，最终决定你的广告竞争力。

**总结：排序层是广告系统的技术核心。它通过强大的深度学习模型，融合海量的用户、广告和环境特征，对召回的广告进行精准的点击率/转化率预测，并最终根据 eCPM 完成排序，实现了广告效果和商业收益的最大化。**
